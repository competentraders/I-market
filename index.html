<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-Market - Festive Shopping for Women and Children</title>
    <!-- Load Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Font and default Tailwind settings -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcf8f3; 
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #f59e0b; /* Amber 500 - festive gold accent */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
        /* Utility class to hide/show the cart modal */
        .cart-modal-hidden {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }
        .cart-modal-visible {
            transform: translateX(0);
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <!-- Logo/Title -->
            <a href="#" class="text-3xl font-extrabold text-red-600 tracking-wider">
                I-Market
            </a>

            <!-- Navigation Links (Hidden on Mobile, shown on Desktop) -->
            <nav class="hidden md:flex space-x-6 text-gray-700 font-medium">
                <a href="#" class="hover:text-red-600 transition duration-150">Home</a>
                <a href="#" class="hover:text-red-600 transition duration-150">Shop</a>
                <a href="#" class="hover:text-red-600 transition duration-150">Gifts for Her</a>
                <a href="#" class="hover:text-red-600 transition duration-150">Kids & Toys</a>
            </nav>

            <!-- Action Icons (Mobile & Desktop) -->
            <div class="flex items-center space-x-4">
                
                <!-- Account Status & Dropdown -->
                <div class="relative inline-block text-left" onmouseleave="window.toggleAuthMenu(false)">
                    <button id="auth-btn" onclick="window.toggleAuthMenu()" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 p-2 rounded-full md:rounded-lg transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <span id="auth-status-text" class="hidden md:inline font-medium text-gray-700 text-sm">Guest</span>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="auth-menu" class="hidden absolute right-0 mt-2 w-48 rounded-lg shadow-xl bg-white ring-1 ring-black ring-opacity-5 z-50 origin-top-right transition-all duration-100 ease-out">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="auth-btn">
                            <a href="login.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Login</a>
                            <a href="register.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Register</a>
                            <div class="border-t border-gray-100"></div>
                            <p id="auth-user-id" class="px-4 py-2 text-xs text-gray-500 truncate" title="User ID">ID: Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Cart Button -->
                <button id="cart-btn" onclick="window.toggleCartModal()" class="text-gray-600 hover:text-red-600 p-2 rounded-full transition duration-150 relative focus:outline-none focus:ring-2 focus:ring-red-400">
                    <!-- Cart Icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                </button>
                
                <!-- Mobile Menu Button -->
                <button class="md:hidden text-gray-600 hover:text-red-600 p-2 rounded-full transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-8 flex-grow">
        <div class="text-center mb-10 p-6 bg-red-100 rounded-xl shadow-inner">
            <h1 class="text-4xl font-extrabold text-red-800 mb-2">Festive Delights Collection</h1>
            <p class="text-lg text-red-600">Perfect gifts for her and magical toys for the little ones this season.</p>
        </div>
        

        <!-- Product Grid -->
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            <!-- Product Cards go here -->
        </div>
    </main>

    <!-- Shopping Cart Modal (Off-Canvas Sidebar) -->
    <div id="cart-modal" class="fixed top-0 right-0 w-full md:w-96 h-full bg-white shadow-2xl z-50 transition-all duration-300 ease-in-out cart-modal-hidden flex flex-col">
        
        <!-- Cart Header -->
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-red-600 text-white">
            <h2 class="text-xl font-bold">Your Festive Cart</h2>
            <button onclick="window.toggleCartModal()" class="text-white hover:text-gray-200 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Cart Items List -->
        <div id="cart-items-container" class="flex-grow overflow-y-auto p-4 space-y-4">
            <p id="empty-cart-message" class="text-gray-500 text-center mt-8">Your cart is empty. Time to shop!</p>
        </div>

        <!-- Cart Footer / Totals -->
        <div class="p-4 border-t border-gray-200 bg-gray-50">
            <div class="flex justify-between items-center mb-4 text-lg font-semibold">
                <span>Subtotal:</span>
                <span id="cart-subtotal" class="text-red-600">$0.00</span>
            </div>
            <button class="w-full bg-amber-500 text-white py-3 rounded-lg font-bold text-lg hover:bg-amber-600 transition duration-300 shadow-xl">
                Proceed to Checkout
            </button>
        </div>
    </div>

    <!-- Backdrop for the modal -->
    <div id="cart-backdrop" onclick="window.toggleCartModal()" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 transition-opacity duration-300 opacity-0 pointer-events-none"></div>


    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-10">
        <div class="container mx-auto px-4 py-8 text-center">
            <p class="text-sm">&copy; 2025 I-Market. Happy Festive Shopping!</p>
            <p id="app-id-display" class="text-xs text-gray-400 mt-2">App ID: Loading...</p>
        </div>
    </footer>

    <!-- Firebase SDK Imports and Core Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Firebase & App Variables ---
        let app;
        let db;
        let auth;
        let userId = null;
        let cart = []; // Local cart state
        const cartCollectionName = 'carts'; // Firestore collection name
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Product Data (Festive Mockup) ---
        // Note: The image URL is set for cart display (80x80) but can be replaced for the grid view
        const mockProducts = [
            { id: 101, name: "Winter Cozy Knit Scarf", price: 45.00, imageUrl: "https://placehold.co/80x80/e9d5ff/4c1d95?text=Scarf", description: "Oversized, ultra-soft knit scarf in cream.", category: "Women's Apparel", rating: 4.8 },
            { id: 102, name: "Magical Unicorn Doll Set", price: 29.99, imageUrl: "https://placehold.co/80x80/a5b4fc/4338ca?text=Doll", description: "A dazzling, articulated unicorn doll with glitter accessories.", category: "Children's Toys", rating: 4.9 },
            { id: 103, name: "Sparkling Pendant Necklace", price: 79.50, imageUrl: "https://placehold.co/80x80/fcd34d/b45309?text=Pendant", description: "Dainty gold-plated necklace with a brilliant simulated diamond pendant.", category: "Women's Jewelry", rating: 4.7 },
            { id: 104, name: "Holiday STEM Building Kit", price: 65.00, imageUrl: "https://placehold.co/80x80/fecaca/991b1b?text=STEM", description: "Build a working motorized carousel—fun and educational!", category: "Children's Toys", rating: 4.5 },
            { id: 105, name: "Luxury Silk Pajama Set", price: 119.99, imageUrl: "https://placehold.co/80x80/fce7f3/9d174d?text=Pajamas", description: "Elegant mulberry silk pajamas for a touch of nightly luxury.", category: "Women's Apparel", rating: 4.9 }
        ];

        // --- Cart Persistence (Firestore) ---
        
        function getUserCartDocRef(uid) {
            return doc(db, 'artifacts', appId, 'users', uid, cartCollectionName, 'user_cart');
        }

        async function saveCart() {
            if (!userId || !db || auth.currentUser === null) {
                // Do not attempt to save if not fully authenticated, just update local state
                updateCartUI();
                return;
            }
            try {
                const cartData = cart.map(item => ({
                    id: item.id,
                    quantity: item.quantity
                }));
                const cartRef = getUserCartDocRef(userId);
                await setDoc(cartRef, { items: cartData, lastUpdated: new Date() });
                console.log("Cart saved successfully to Firestore.");
            } catch (error) {
                console.error("Error saving cart:", error);
            }
        }

        function listenToCart() {
            if (!userId || !db) return;
            const cartRef = getUserCartDocRef(userId);
            
            onSnapshot(cartRef, (doc) => {
                if (doc.exists()) {
                    const savedCartItems = doc.data().items || [];
                    
                    cart = savedCartItems.map(savedItem => {
                        const product = mockProducts.find(p => p.id === savedItem.id);
                        if (product) {
                            return { ...product, quantity: savedItem.quantity };
                        }
                        return null;
                    }).filter(item => item !== null);

                    console.log("Cart loaded successfully from Firestore:", cart);
                } else {
                    cart = [];
                    console.log("No cart data found for user. Initializing empty cart.");
                }
                updateCartUI(); // Update UI whenever the cart state changes
            }, (error) => {
                console.error("Error listening to cart:", error);
                updateAuthStatus(auth.currentUser); // Ensure status reflects reality if error
            });
        }


        // --- Cart UI Management ---

        function updateCartUI() {
            const container = document.getElementById('cart-items-container');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            let subtotal = 0;
            
            document.getElementById('cart-count').textContent = totalItems;
            container.innerHTML = ''; 

            if (cart.length === 0) {
                document.getElementById('empty-cart-message').style.display = 'block';
                document.getElementById('cart-subtotal').textContent = '$0.00';
                return;
            }

            document.getElementById('empty-cart-message').style.display = 'none';

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center space-x-4 p-3 bg-white border border-gray-200 rounded-xl shadow-md';
                itemElement.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0 border border-gray-100" 
                         onerror="this.onerror=null;this.src='https://placehold.co/80x80/9ca3af/ffffff?text=X';" />
                    
                    <div class="flex-grow min-w-0">
                        <h4 class="text-sm font-bold text-gray-900 truncate">${item.name}</h4>
                        <p class="text-xs text-gray-500">Price: $${item.price.toFixed(2)}</p>
                        <p class="text-xs font-semibold text-red-600 mt-1">Total: $${itemTotal.toFixed(2)}</p>
                    </div>
                    
                    <div class="flex flex-col items-center space-y-1">
                        <span class="text-xs text-gray-500">Qty:</span>
                        <div class="flex items-center space-x-0.5 border border-gray-300 rounded-lg">
                            <button onclick="window.updateQuantity(${item.id}, -1)" class="p-1 text-gray-600 hover:text-red-600 transition disabled:opacity-50" ${item.quantity <= 1 ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                            </button>
                            <span class="font-medium text-gray-900 text-sm">${item.quantity}</span>
                            <button onclick="window.updateQuantity(${item.id}, 1)" class="p-1 text-gray-600 hover:text-red-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            </button>
                        </div>
                        <button onclick="window.updateQuantity(${item.id}, -${item.quantity})" class="text-xs text-red-500 hover:text-red-700 transition mt-2">
                           Remove
                        </button>
                    </div>
                `;
                container.appendChild(itemElement);
            });

            document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
        }

        // --- Cart Action Handlers (Globally Accessible) ---

        window.addToCart = function(productId) {
            const product = mockProducts.find(p => p.id === productId);
            if (product) {
                const existingItem = cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }
                saveCart(); // Save state to Firestore
                
                // Temporary visual feedback
                const cartButton = document.getElementById('cart-btn');
                cartButton.classList.add('animate-pulse', 'ring-4', 'ring-red-300');
                setTimeout(() => {
                    cartButton.classList.remove('animate-pulse', 'ring-4', 'ring-red-300');
                }, 500);
            }
        }

        window.updateQuantity = function(productId, delta) {
            const itemIndex = cart.findIndex(item => item.id === productId);

            if (itemIndex > -1) {
                const newQuantity = cart[itemIndex].quantity + delta;
                
                if (newQuantity <= 0) {
                    cart.splice(itemIndex, 1);
                } else {
                    cart[itemIndex].quantity = newQuantity;
                }
                saveCart(); // Save state to Firestore
            }
        }


        // --- Modal & Auth Control ---
        
        // Auth Menu Dropdown Toggle
        window.toggleAuthMenu = function(show) {
            const menu = document.getElementById('auth-menu');
            if (typeof show === 'boolean') {
                menu.style.display = show ? 'block' : 'none';
            } else {
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }
        }

        // Cart Modal Toggle
        window.toggleCartModal = function() {
            const modal = document.getElementById('cart-modal');
            const backdrop = document.getElementById('cart-backdrop');
            
            const isVisible = modal.classList.toggle('cart-modal-visible');
            modal.classList.toggle('cart-modal-hidden');

            if (isVisible) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                backdrop.classList.add('opacity-100');
            } else {
                backdrop.classList.remove('opacity-100');
                backdrop.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // Updates the Account Button based on auth state
        function updateAuthStatus(user) {
            const statusText = document.getElementById('auth-status-text');
            const userIdText = document.getElementById('auth-user-id');
            const authIcon = document.querySelector('#auth-btn svg');
            const authBtn = document.getElementById('auth-btn');

            if (user) {
                userId = user.uid;
                statusText.textContent = 'Account';
                userIdText.textContent = `ID: ${user.uid.substring(0, 8)}...`;
                authBtn.classList.remove('bg-gray-100');
                authBtn.classList.add('bg-green-500/10');
                authIcon.classList.remove('text-gray-600');
                authIcon.classList.add('text-green-600');
            } else {
                userId = crypto.randomUUID(); // Fallback for anon/signed out
                statusText.textContent = 'Guest';
                userIdText.textContent = `ID: ${userId.substring(0, 8)}... (Guest)`;
                authBtn.classList.add('bg-gray-100');
                authBtn.classList.remove('bg-green-500/10');
                authIcon.classList.add('text-gray-600');
                authIcon.classList.remove('text-green-600');
            }
        }
        
        // --- Product Grid Rendering ---
        function renderProducts() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = ''; 

            mockProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden transform hover:scale-[1.02] cursor-pointer border border-gray-100';

                const ratingStars = '★'.repeat(Math.floor(product.rating)) + '☆'.repeat(5 - Math.floor(product.rating));
                // Use a larger image for the main grid display (400x300)
                const largeImageUrl = product.imageUrl.replace('80x80', '400x300').replace('Scarf', 'Luxury+Scarf').replace('Doll', 'Toy+Doll').replace('Pendant', 'Diamond+Pendant').replace('STEM', 'Toy+Kit').replace('Pajamas', 'Silk+Pajamas');

                productCard.innerHTML = `
                    <!-- Image -->
                    <div class="h-48 overflow-hidden bg-gray-50 flex items-center justify-center">
                        <img src="${largeImageUrl}" alt="${product.name}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-110" 
                             onerror="this.onerror=null;this.src='https://placehold.co/400x300/f87171/ffffff?text=Image+Unavailable';" />
                    </div>
                    <!-- Details -->
                    <div class="p-6">
                        <p class="text-xs font-semibold text-red-500 mb-1 uppercase tracking-wider">${product.category}</p>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${product.name}</h3>
                        <p class="text-gray-500 text-sm mb-3 h-10 overflow-hidden">${product.description}</p>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-2xl font-extrabold text-red-600">$${product.price.toFixed(2)}</span>
                            <span class="text-yellow-500 font-mono text-sm">${ratingStars} (${product.rating})</span>
                        </div>
                        <button onclick="window.addToCart(${product.id})" class="w-full bg-red-500 text-white py-2 rounded-lg font-medium hover:bg-red-600 transition duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-red-300">
                            Add to Cart
                        </button>
                    </div>
                `;
                grid.appendChild(productCard);
            });
        }

        // --- Function to Initialize Firebase & Authenticate ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); 

                document.getElementById('app-id-display').textContent = `App ID: ${appId}`;

                onAuthStateChanged(auth, (user) => {
                    updateAuthStatus(user);
                    if (user) {
                        console.log("Firebase Auth Ready. User ID:", userId);
                        listenToCart(); 
                    } else {
                        // For anonymous user, ensure UI updates from local state until login/register
                        console.log("User is signed out. Using temporary ID.");
                        updateCartUI();
                    }
                    renderProducts(); 
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

            } catch (error) {
                console.error("Firebase Initialization or Sign-in Error:", error);
                userId = crypto.randomUUID();
                updateAuthStatus(null); // Show guest status on error
                renderProducts();
                updateCartUI();
            }
        }

        // --- Start the Application ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>

