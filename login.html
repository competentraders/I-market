<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-Market Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcf8f3; 
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8 border-t-8 border-red-600">
        <h1 class="text-3xl font-extrabold text-red-600 mb-2 text-center">I-Market</h1>
        <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Sign In to Your Account</h2>
        
        <form id="login-form">
            <div class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
            </div>
            <div id="login-error" class="text-red-500 text-sm mt-4 hidden text-center font-medium"></div>
            <button type="submit" id="login-btn" class="w-full mt-6 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition duration-300 shadow-lg disabled:opacity-50">
                Login
            </button>
        </form>

        <p class="mt-6 text-center text-sm">
            Need an account? 
            <a href="register.html" class="font-medium text-amber-600 hover:text-amber-500">Register Here</a>
        </p>
        <p class="mt-2 text-center text-sm">
            <a href="index.html" class="text-gray-500 hover:text-gray-700">‚Üê Back to Shopping</a>
        </p>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuration and Target URL
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const TARGET_URL = 'product-i-market.html'; // CORRECTED TARGET URL

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginBtn = document.getElementById('login-btn');

        function displayError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            loginError.style.display = 'none';
            loginBtn.textContent = 'Logging In...';
            loginBtn.disabled = true;

            try {
                // Ensure persistence is set for normal email/password login
                await setPersistence(auth, browserLocalPersistence);
                
                await signInWithEmailAndPassword(auth, email, password);
                
                loginBtn.textContent = 'Success!';
                displayError('Login successful! Redirecting...');
                
                setTimeout(() => {
                    window.location.href = TARGET_URL;
                }, 1000);

            } catch (error) {
                console.error("Login Error:", error);
                let message = 'Login failed. Please check your email and password.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    message = 'Invalid email or password.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'The email address is not valid.';
                }
                displayError(message);
                loginBtn.textContent = 'Login';
                loginBtn.disabled = false;
            }
        });

        // Handle initial environment authentication state (if any)
        window.onload = async function() {
            if (initialAuthToken) {
                try {
                    // Sign in with the custom token provided by the canvas environment
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.warn("Custom token sign-in failed, proceeding anonymously:", error);
                    await signInAnonymously(auth);
                }
            } else {
                 // For standalone use or if token is absent, sign in anonymously for basic access
                 await signInAnonymously(auth);
            }
        }
    </script>
</body>
</html>

