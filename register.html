<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-Market Register - Complete Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-xl bg-white rounded-xl shadow-2xl p-6 sm:p-10">
        <h1 class="text-3xl font-extrabold text-red-600 text-center mb-2">I-Market</h1>
        <h2 class="text-xl font-semibold text-gray-800 text-center mb-6">Create Your Account</h2>

        <!-- Notification/Error Message Area -->
        <div id="auth-status" class="hidden p-3 mb-4 rounded-lg text-center font-medium"></div>

        <!-- Detailed Register Form -->
        <form id="register-form" class="space-y-6">

            <!-- Name and Birth Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="first-name" class="block text-sm font-medium text-gray-700">First Name</label>
                    <input type="text" id="first-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
                <div>
                    <label for="last-name" class="block text-sm font-medium text-gray-700">Last Name</label>
                    <input type="text" id="last-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
                <div>
                    <label for="date-of-birth" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                    <input type="date" id="date-of-birth" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select id="gender" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border bg-white">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Contact Information -->
            <div>
                <label for="phone-number" class="block text-sm font-medium text-gray-700">Phone Number</label>
                <input type="tel" id="phone-number" required placeholder="(123) 456-7890" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
            </div>

            <!-- Email and Confirmation -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="register-email" required placeholder="name@example.com" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
                <div>
                    <label for="confirm-email" class="block text-sm font-medium text-gray-700">Confirm Email</label>
                    <input type="email" id="confirm-email" required placeholder="name@example.com" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
            </div>

            <!-- Password Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="register-password" required placeholder="Must be at least 6 characters" minlength="6" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
                <div>
                    <label for="register-confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                    <input type="password" id="register-confirm-password" required placeholder="Re-enter your password" minlength="6" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
            </div>

            <!-- Address Fields -->
            <div>
                <label for="address" class="block text-sm font-medium text-gray-700">Billing Address</label>
                <input type="text" id="address" required placeholder="Street Address, City, State" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
            </div>
            <div>
                <label for="delivery-address" class="block text-sm font-medium text-gray-700">Delivery Address</label>
                <input type="text" id="delivery-address" required placeholder="Street Address, City, State" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="zip-code" class="block text-sm font-medium text-gray-700">Zip / Postal Code</label>
                    <input type="text" id="zip-code" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition duration-300 shadow-lg">
                Create Account & Go to Marketplace
            </button>
        </form>

        <p class="mt-6 text-center text-sm text-gray-600">
            Already have an account? 
            <a href="login.html" class="font-medium text-red-600 hover:text-red-700 transition">Log In here</a>
        </p>

    </div>

    <!-- Firebase Authentication and Firestore Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- CONFIGURATION & GLOBAL STATE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let auth;
        let db;
        let isFirebaseReady = false;

        // --- DOM Elements ---
        const authStatus = document.getElementById('auth-status');
        const registerForm = document.getElementById('register-form');
        const REDIRECT_PAGE = 'productmarket.html';

        // --- UTILITY FUNCTIONS ---

        function setStatus(message, isError = false) {
            authStatus.textContent = message;
            authStatus.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            authStatus.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
            authStatus.classList.add(isError ? 'text-red-700' : 'text-green-700');
            if (!isError) {
                setTimeout(() => authStatus.classList.add('hidden'), 3000);
            }
        }
        
        // --- FIREBASE INITIALIZATION ---

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await setPersistence(auth, browserLocalPersistence);
                setLogLevel('debug'); 
                isFirebaseReady = true;

                // Check if the user is already authenticated
                onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                         setStatus("Already logged in. Redirecting...", false);
                         // Redirect if user is already logged in
                         window.location.href = REDIRECT_PAGE;
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                setStatus("Critical Error: Failed to connect to authentication service.", true);
            }
        }

        // --- REGISTRATION LOGIC ---

        async function handleRegister(e) {
            e.preventDefault();
            if (!isFirebaseReady) {
                setStatus("System initializing, please wait.", true);
                return;
            }

            // Get all form data
            const email = document.getElementById('register-email').value;
            const confirmEmail = document.getElementById('confirm-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const btn = registerForm.querySelector('button');

            // --- Form Validation ---
            if (email !== confirmEmail) {
                setStatus("Error: Emails do not match.", true);
                return;
            }
            if (password !== confirmPassword) {
                setStatus("Error: Passwords do not match.", true);
                return;
            }
            if (password.length < 6) {
                setStatus("Error: Password must be at least 6 characters long.", true);
                return;
            }

            btn.disabled = true;
            setStatus("Creating account and saving profile...", false);

            try {
                // 1. Create User in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                
                // 2. Gather remaining profile data
                const profileData = {
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    phoneNumber: document.getElementById('phone-number').value,
                    email: email, // Already validated
                    billingAddress: document.getElementById('address').value,
                    deliveryAddress: document.getElementById('delivery-address').value,
                    gender: document.getElementById('gender').value,
                    dateOfBirth: document.getElementById('date-of-birth').value,
                    zipCode: document.getElementById('zip-code').value,
                    createdAt: new Date().toISOString(),
                };

                // 3. Save profile data to Firestore
                const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
                await setDoc(profileRef, profileData);

                // --- MANDATORY REDIRECTION POINT ---
                setStatus("Registration complete! Redirecting to marketplace...", false);
                window.location.href = REDIRECT_PAGE;

            } catch (error) {
                console.error("Registration failed:", error);
                let errorMessage = "Registration failed.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already in use. Please log in.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                } else {
                    errorMessage = `Registration failed: ${error.message}`;
                }

                setStatus(errorMessage, true);
                btn.disabled = false;
            }
        }

        // --- Event Listeners and Initialization ---

        registerForm.addEventListener('submit', handleRegister);
        initializeFirebase();
        
    </script>
</body>
</html>

