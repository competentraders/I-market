<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-Market Global Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons from Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .cart-sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .cart-sidebar.open {
            transform: translateX(0);
        }
        .scrollable {
            max-height: calc(100vh - 200px); /* Height for cart items list */
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header / Navigation -->
    <header class="sticky top-0 z-20 bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-red-600">I-Market</h1>
            <div class="flex items-center space-x-4">
                <span id="user-display" class="text-sm font-medium text-gray-700">Initializing...</span>
                
                <!-- Cart Button -->
                <button id="cart-btn" class="relative p-2 rounded-full bg-amber-100 text-amber-600 hover:bg-amber-200 transition">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                </button>

                <!-- Logout Button -->
                <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-600 transition disabled:opacity-50" disabled>
                    <i data-lucide="log-out" class="w-5 h-5 inline-block align-middle mr-1"></i>
                    Logout
                </button>
            </div>
        </div>
        <!-- Global Error/Status Bar -->
        <div id="global-error-bar" class="hidden bg-red-100 text-red-700 p-2 text-center text-sm font-medium">
            <!-- Global error messages will be displayed here -->
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Explore Our Marketplace</h2>
        
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Products will be injected here -->
            <div id="loading-products" class="col-span-full text-center py-10 text-gray-500">Loading Products...</div>
        </div>
    </main>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="cart-sidebar fixed top-0 right-0 w-full md:w-96 h-full bg-white shadow-2xl z-30 flex flex-col p-6">
        <div class="flex justify-between items-center border-b pb-4 mb-4">
            <h3 class="text-2xl font-bold text-gray-800">Your Cart</h3>
            <button id="close-cart-btn" class="text-gray-500 hover:text-gray-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Cart Content -->
        <div id="cart-items-container" class="flex-grow scrollable pr-2">
            <!-- Cart items will be rendered here -->
            <div id="empty-cart-message" class="text-center py-10 text-gray-500">
                <i data-lucide="box" class="w-10 h-10 mx-auto mb-3"></i>
                Your cart is empty.
            </div>
        </div>

        <!-- Cart Summary and Checkout Button -->
        <div id="cart-summary" class="mt-4 pt-4 border-t sticky bottom-0 bg-white">
            <div class="flex justify-between font-semibold text-lg mb-2">
                <span>Subtotal:</span>
                <span id="cart-subtotal">$0.00</span>
            </div>
            <div class="flex justify-between font-semibold text-xl text-red-600 mb-4">
                <span>Total:</span>
                <span id="cart-total">$0.00</span>
            </div>
            <button id="checkout-btn" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition duration-300 shadow-lg disabled:opacity-50" disabled>
                Proceed to Checkout
            </button>
        </div>
    </div>
    
    <!-- Payment Modal (Hidden by Default) -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h4 class="text-xl font-bold text-gray-800">Select Payment Method</h4>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="payment-details" class="space-y-4">
                <div class="text-lg font-semibold text-gray-700">Order Total: <span id="modal-total" class="text-red-600">$0.00</span></div>
                
                <!-- Payment Options Tabs -->
                <div class="flex border-b">
                    <button data-method="crypto" class="payment-tab px-4 py-2 border-b-2 border-red-600 text-red-600 font-semibold transition">Crypto Payment</button>
                    <button data-method="giftcard" class="payment-tab px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold transition">Gift Card</button>
                </div>

                <!-- Crypto Form (Default) -->
                <form id="crypto-form" class="space-y-4 pt-4">
                    <p class="text-sm text-gray-600">Please send the exact amount to the temporary wallet address below. Your order will be confirmed upon blockchain verification (simulated).</p>
                    <div class="bg-gray-100 p-3 rounded-lg border border-dashed border-gray-400">
                        <label class="block text-xs font-medium text-gray-500">Temporary Wallet Address (BTC)</label>
                        <p id="crypto-address" class="font-mono text-sm text-gray-800 break-all select-all">1A8hYw5yXvX7Z9tNfK3pQd2rF4gJ6mP</p>
                    </div>
                    <div>
                        <label for="crypto-txid" class="block text-sm font-medium text-gray-700">Transaction ID (TXID)</label>
                        <input type="text" id="crypto-txid" required placeholder="Enter transaction ID for confirmation" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-300">
                        Confirm Crypto Payment
                    </button>
                </form>

                <!-- Gift Card Form -->
                <form id="giftcard-form" class="space-y-4 pt-4 hidden">
                    <p class="text-sm text-gray-600">Enter your gift card details below. The card balance will be applied to your total.</p>
                    <div>
                        <label for="giftcard-number" class="block text-sm font-medium text-gray-700">Gift Card Number</label>
                        <input type="text" id="giftcard-number" required placeholder="16-digit card number" maxlength="16" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                    </div>
                    <div>
                        <label for="giftcard-pin" class="block text-sm font-medium text-gray-700">PIN / Security Code</label>
                        <input type="text" id="giftcard-pin" required placeholder="4-digit PIN" maxlength="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 border">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-300">
                        Redeem Gift Card & Confirm
                    </button>
                </form>
            </div>
            
            <div id="payment-status" class="mt-4 text-center text-sm font-medium hidden"></div>

        </div>
    </div>


    <!-- Firebase Logic and Application Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, addDoc, setLogLevel, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION & GLOBAL STATE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db;
        let userId = null;
        let cartItems = [];
        let isAuthReady = false;

        // Mock Product Data (Public Data from various "stores")
        const PRODUCTS = [
            { id: 'p001', name: 'Ultra HD Monitor (32")', price: 299.99, storeId: 's01', storeName: 'Tech Central', imageUrl: 'https://placehold.co/400x300/1e40af/ffffff?text=Monitor' },
            { id: 'p002', name: 'Mechanical Keyboard (RGB)', price: 89.99, storeId: 's01', storeName: 'Tech Central', imageUrl: 'https://placehold.co/400x300/1e40af/ffffff?text=Keyboard' },
            { id: 'p003', name: 'Organic Coffee Beans (1lb)', price: 15.50, storeId: 's02', storeName: 'Green Foods Co.', imageUrl: 'https://placehold.co/400x300/059669/ffffff?text=Coffee' },
            { id: 'p004', name: 'Artisan Sourdough Loaf', price: 7.99, storeId: 's02', storeName: 'Green Foods Co.', imageUrl: 'https://placehold.co/400x300/059669/ffffff?text=Bread' },
            { id: 'p005', name: 'Summer Linen Shirt', price: 45.00, storeId: 's03', storeName: 'The Fashion Hub', imageUrl: 'https://placehold.co/400x300/9d174d/ffffff?text=Shirt' },
            { id: 'p006', name: 'Classic Leather Belt', price: 35.00, storeId: 's03', storeName: 'The Fashion Hub', imageUrl: 'https://placehold.co/400x300/9d174d/ffffff?text=Belt' },
            { id: 'p007', name: 'Acoustic Guitar (Starter)', price: 120.00, storeId: 's04', storeName: 'Music House', imageUrl: 'https://placehold.co/400x300/581c87/ffffff?text=Guitar' },
            { id: 'p008', name: 'Sketchbook & Pencils Set', price: 22.50, storeId: 's04', storeName: 'Music House', imageUrl: 'https://placehold.co/400x300/581c87/ffffff?text=Art+Kit' },
        ];
        const PRODUCT_MAP = PRODUCTS.reduce((map, p) => (map[p.id] = p, map), {});


        // --- DOM ELEMENTS ---
        const productGrid = document.getElementById('product-grid');
        const loadingProducts = document.getElementById('loading-products');
        const cartSidebar = document.getElementById('cart-sidebar');
        const cartBtn = document.getElementById('cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartCount = document.getElementById('cart-count');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartSubtotalSpan = document.getElementById('cart-subtotal');
        const cartTotalSpan = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const globalErrorBar = document.getElementById('global-error-bar');
        
        // Modal Elements
        const paymentModal = document.getElementById('payment-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalTotalSpan = document.getElementById('modal-total');
        const paymentTabs = document.querySelectorAll('.payment-tab');
        const cryptoForm = document.getElementById('crypto-form');
        const giftcardForm = document.getElementById('giftcard-form');
        const paymentStatus = document.getElementById('payment-status');
        
        let currentPaymentMethod = 'crypto';


        // --- UTILITY FUNCTIONS ---

        function displayGlobalError(message, type = 'error') {
            globalErrorBar.textContent = message;
            globalErrorBar.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
            globalErrorBar.classList.add(type === 'success' ? 'bg-green-100' : 'bg-red-100');
            setTimeout(() => {
                globalErrorBar.classList.add('hidden');
            }, 5000);
        }

        function formatCurrency(amount) {
            return `$${amount.toFixed(2)}`;
        }

        function getCartItemsCollectionRef() {
            if (!userId || !appId) return null;
            // Private user cart path
            return collection(db, 'artifacts', appId, 'users', userId, 'cart_items');
        }


        // --- FIREBASE INITIALIZATION & AUTH ---

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');
                
                // Sign in with token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                displayGlobalError("Critical Error: Failed to connect to Firebase.");
            }
        }

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            if (user) {
                userId = user.uid;
                const displayId = userId.length > 8 ? `${userId.substring(0, 8)}...` : userId;
                userDisplay.textContent = `User: ${displayId}`;
                logoutBtn.disabled = false;
                // Start listening to the cart data
                setupCartListener();
            } else {
                userId = null;
                userDisplay.textContent = 'Please log in or register.';
                logoutBtn.disabled = true;
                cartItems = [];
                renderCart(); // Clear cart display
            }
        });


        // --- FIRESTORE CART OPERATIONS ---

        function setupCartListener() {
            const cartRef = getCartItemsCollectionRef();
            if (!cartRef) return; // Should not happen if auth is working
            
            // Clear any old listeners before setting a new one
            // (Note: onSnapshot returns an unsubscribe function, but for simplicity, we rely on auth change).

            onSnapshot(cartRef, (snapshot) => {
                const newCartItems = [];
                snapshot.forEach(doc => {
                    const item = doc.data();
                    // Ensure the item exists in the product map and has quantity > 0
                    if (PRODUCT_MAP[item.productId] && item.quantity > 0) {
                        newCartItems.push({
                            id: doc.id, // Firestore document ID
                            productId: item.productId,
                            quantity: item.quantity,
                            ...PRODUCT_MAP[item.productId] // Merge product details
                        });
                    } else if (item.quantity <= 0) {
                        // Clean up zero/negative quantity items (optional cleanup)
                        deleteDoc(doc.ref).catch(err => console.error("Failed to clean up zero quantity item:", err));
                    }
                });
                cartItems = newCartItems;
                renderCart();
            }, (error) => {
                console.error("Error listening to cart changes:", error);
                displayGlobalError("Error fetching cart data. Check console for details.");
            });
        }
        
        async function updateCartItem(productId, newQuantity) {
            if (!userId) {
                displayGlobalError('You must be logged in to modify your cart. Please log in or register.', 'error');
                return;
            }
            if (newQuantity < 0) return;

            const cartRef = getCartItemsCollectionRef();
            if (!cartRef) return;
            
            const existingItem = cartItems.find(item => item.productId === productId);

            const batch = writeBatch(db);

            if (newQuantity === 0) {
                // Remove the item
                if (existingItem) {
                    batch.delete(doc(cartRef, existingItem.id));
                }
            } else {
                // Add or update the item
                if (existingItem) {
                    // Update existing item
                    batch.update(doc(cartRef, existingItem.id), { quantity: newQuantity });
                } else {
                    // Add new item (only if newQuantity > 0)
                    const newItemRef = doc(cartRef); // Let Firestore generate the ID
                    batch.set(newItemRef, { 
                        productId: productId, 
                        quantity: newQuantity,
                        addedAt: new Date().toISOString()
                    });
                }
            }
            
            try {
                await batch.commit();
            } catch (error) {
                console.error("Error updating cart:", error);
                displayGlobalError(`Failed to update cart: ${error.message}`);
            }
        }


        // --- RENDERING FUNCTIONS ---
        
        function renderProducts() {
            loadingProducts.classList.add('hidden');
            productGrid.innerHTML = ''; 

            PRODUCTS.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden';
                productCard.innerHTML = `
                    <div class="h-48 overflow-hidden bg-gray-50 border-b">
                        <img src="${product.imageUrl}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/000000?text=Product+Image';" class="w-full h-full object-cover">
                    </div>
                    <div class="p-5">
                        <span class="inline-block text-xs font-semibold text-gray-500 mb-1">${product.storeName}</span>
                        <h4 class="text-lg font-bold text-gray-800">${product.name}</h4>
                        <p class="text-2xl font-extrabold text-red-600 my-2">${formatCurrency(product.price)}</p>
                        <button data-product-id="${product.id}" class="add-to-cart-btn w-full bg-amber-500 text-white py-2 rounded-lg font-semibold hover:bg-amber-600 transition shadow-md">
                            Add to Cart
                        </button>
                    </div>
                `;
                productGrid.appendChild(productCard);
            });
            
            // Add event listeners after rendering
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (!userId) {
                        displayGlobalError("Please log in or register to add items to the cart.", 'error');
                        return;
                    }
                    const productId = e.currentTarget.dataset.productId;
                    const existingItem = cartItems.find(item => item.productId === productId);
                    const newQuantity = existingItem ? existingItem.quantity + 1 : 1;
                    updateCartItem(productId, newQuantity);
                });
            });
            
            lucide.createIcons();
        }

        function renderCart() {
            cartItemsContainer.innerHTML = '';
            let subtotal = 0;

            if (cartItems.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                checkoutBtn.disabled = true;
            } else {
                emptyCartMessage.classList.add('hidden');
                checkoutBtn.disabled = false;

                cartItems.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;

                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'flex items-center space-x-4 p-3 border-b last:border-b-0';
                    cartItemDiv.innerHTML = `
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg border">
                        <div class="flex-grow">
                            <p class="text-sm font-semibold text-gray-800 leading-tight">${item.name}</p>
                            <p class="text-xs text-gray-500">Store: ${item.storeName}</p>
                            <p class="text-sm font-bold text-red-600">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-product-id="${item.productId}" data-action="decrement" class="quantity-btn p-1 border rounded-md hover:bg-gray-100 transition">
                                <i data-lucide="minus" class="w-4 h-4"></i>
                            </button>
                            <span class="text-sm font-medium w-4 text-center">${item.quantity}</span>
                            <button data-product-id="${item.productId}" data-action="increment" class="quantity-btn p-1 border rounded-md hover:bg-gray-100 transition">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <button data-product-id="${item.productId}" data-action="remove" class="remove-btn text-gray-400 hover:text-red-500 transition">
                             <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);
                });

                // Add event listeners for cart item updates
                document.querySelectorAll('.quantity-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        const action = e.currentTarget.dataset.action;
                        const item = cartItems.find(i => i.productId === productId);
                        
                        if (item) {
                            let newQuantity = item.quantity;
                            if (action === 'increment') {
                                newQuantity += 1;
                            } else if (action === 'decrement') {
                                newQuantity -= 1;
                            }
                            updateCartItem(productId, newQuantity);
                        }
                    });
                });
                
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        updateCartItem(productId, 0); // Set quantity to zero to remove
                    });
                });
            }

            // Update totals
            const taxRate = 0.05; // 5% flat tax
            const tax = subtotal * taxRate;
            const total = subtotal + tax;

            cartSubtotalSpan.textContent = formatCurrency(subtotal);
            cartTotalSpan.textContent = formatCurrency(total);
            modalTotalSpan.textContent = formatCurrency(total); // Update modal total

            cartCount.textContent = cartItems.reduce((sum, item) => sum + item.quantity, 0);

            lucide.createIcons();
        }

        // --- UI & EVENT HANDLERS ---

        function alertModalStatus(message, type = 'error') {
            paymentStatus.textContent = message;
            paymentStatus.classList.remove('hidden', 'text-green-600', 'text-red-600');
            paymentStatus.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
        }

        function clearPaymentStatus() {
             paymentStatus.classList.add('hidden');
        }

        function openCart() {
            cartSidebar.classList.add('open');
            document.body.style.overflow = 'hidden'; 
        }

        function closeCart() {
            cartSidebar.classList.remove('open');
            document.body.style.overflow = '';
            paymentModal.classList.add('hidden');
        }
        
        function openPaymentModal() {
            if (!userId) {
                displayGlobalError("You must be logged in to checkout.", 'error');
                return;
            }
            if (cartItems.length === 0) {
                alertModalStatus("Your cart is empty. Please add items before checking out.");
                return;
            }
            paymentModal.classList.remove('hidden');
            cartSidebar.classList.remove('open');
            document.body.style.overflow = 'hidden';
            clearPaymentStatus();
        }

        function closePaymentModal() {
            paymentModal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // Redirect back to login page after signing out
                window.location.href = 'login.html'; 
            } catch (error) {
                console.error("Logout failed:", error);
                displayGlobalError("Logout failed. Please try again.");
            }
        }
        
        // --- PAYMENT & CHECKOUT LOGIC ---

        function switchPaymentMethod(method) {
            currentPaymentMethod = method;
            paymentTabs.forEach(tab => {
                const isSelected = tab.dataset.method === method;
                tab.classList.toggle('border-red-600', isSelected);
                tab.classList.toggle('text-red-600', isSelected);
                tab.classList.toggle('border-transparent', !isSelected);
                tab.classList.toggle('text-gray-500', !isSelected);
            });

            cryptoForm.classList.toggle('hidden', method !== 'crypto');
            giftcardForm.classList.toggle('hidden', method !== 'giftcard');
        }

        async function finalizeOrder() {
            if (!userId) {
                alertModalStatus('Authentication failed. Please re-login.');
                return false;
            }

            const batch = writeBatch(db);
            const orderId = `ORDER_${Date.now()}`;
            // Use the public path for historical orders, or private for user history
            // Sticking to private path for user history consistency
            const orderRef = doc(db, 'artifacts', appId, 'users', userId, 'orders', orderId);
            const cartRef = getCartItemsCollectionRef();

            // 1. Create Order in Firestore
            const orderData = {
                orderId: orderId,
                userId: userId,
                items: cartItems.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    storeName: item.storeName
                })),
                totalAmount: parseFloat(cartTotalSpan.textContent.replace('$', '')),
                paymentMethod: currentPaymentMethod,
                status: 'Processing',
                createdAt: new Date().toISOString()
            };

            batch.set(orderRef, orderData);

            // 2. Clear Cart (delete all items in the cart collection)
            const cartSnapshot = await getDocs(cartRef);
            cartSnapshot.forEach(cartDoc => {
                batch.delete(cartDoc.ref);
            });

            try {
                await batch.commit();
                return true;
            } catch (error) {
                console.error("Failed to finalize order and clear cart:", error);
                alertModalStatus(`Payment confirmed, but failed to record order: ${error.message}`);
                return false;
            }
        }

        // --- Event Listeners ---

        cartBtn.addEventListener('click', openCart);
        closeCartBtn.addEventListener('click', closeCart);
        checkoutBtn.addEventListener('click', openPaymentModal);
        closeModalBtn.addEventListener('click', closePaymentModal);
        logoutBtn.addEventListener('click', handleLogout);

        paymentTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                switchPaymentMethod(e.target.dataset.method);
                clearPaymentStatus();
            });
        });

        // Crypto Payment Submission (Simulated)
        cryptoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const txid = document.getElementById('crypto-txid').value.trim();
            if (txid.length < 10) {
                alertModalStatus("Please enter a valid Transaction ID.");
                return;
            }
            
            cryptoForm.querySelector('button').disabled = true;
            alertModalStatus("Payment processing...", 'info');

            // Simulate blockchain confirmation delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const success = await finalizeOrder();
            
            cryptoForm.querySelector('button').disabled = false;

            if (success) {
                alertModalStatus("Payment confirmed and Order Placed successfully! Thank you for your purchase.", 'success');
                cryptoForm.reset();
                setTimeout(closePaymentModal, 3000);
            }
        });

        // Gift Card Submission (Simulated)
        giftcardForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cardNum = document.getElementById('giftcard-number').value.trim();
            const pin = document.getElementById('giftcard-pin').value.trim();
            
            if (cardNum.length !== 16 || pin.length !== 4) {
                 alertModalStatus("Invalid Gift Card number or PIN format.");
                return;
            }
            
            giftcardForm.querySelector('button').disabled = true;
            alertModalStatus("Verifying Gift Card balance...", 'info');

            // Simulate API verification delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const success = await finalizeOrder();
            
            giftcardForm.querySelector('button').disabled = false;

            if (success) {
                alertModalStatus("Gift Card redeemed and Order Placed! Thank you for your purchase.", 'success');
                giftcardForm.reset();
                setTimeout(closePaymentModal, 3000);
            }
        });

        // --- INITIAL SETUP ---
        initializeFirebase().then(() => {
            renderProducts();
        });
        
        lucide.createIcons();
    </script>
</body>
</html>

